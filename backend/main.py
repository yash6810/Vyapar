import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from fastapi import FastAPI, UploadFile, File, Request, HTTPException
import requests
from pydantic import BaseModel
from schemas import validate_invoice, validate_expense
from workflow_runner import create_invoice, record_expense
from whatsapp_adapter import WhatsAppAdapter
import json

import logging

import uuid

# Configure logging
formatter = logging.Formatter('%(asctime)s - %(levelname)s - [%(request_id)s] - %(message)s')
handler = logging.StreamHandler()
handler.setFormatter(formatter)
file_handler = logging.FileHandler("backend.log")
file_handler.setFormatter(formatter)
logger = logging.getLogger()
logger.setLevel(logging.INFO)
logger.addHandler(handler)
logger.addHandler(file_handler)

whatsapp = WhatsAppAdapter()
HF_URL = 'http://localhost:8080/generate'
ASR_URL = 'http://localhost:8001/transcribe'
INTENT_URL = 'http://localhost:8002/classify'

class WebhookIn(BaseModel):
    from_number: str

app = FastAPI()

@app.middleware("http")
async def add_request_id(request: Request, call_next):
    request_id = request.headers.get("X-Request-ID")
    if not request_id:
        request_id = str(uuid.uuid4())
    
    # Add request_id to log record
    extra = {'request_id': request_id}
    old_factory = logging.getLogRecordFactory()
    def record_factory(*args, **kwargs):
        record = old_factory(*args, **kwargs)
        record.request_id = extra['request_id']
        return record
    logging.setLogRecordFactory(record_factory)

    response = await call_next(request)
    return response

async def process_document(intent: str, asr_text: str, from_number: str):
    if intent == 'expense_record':
        doc_type = 'expense'
        validator = validate_expense
        runner = record_expense
        prompt = f"Extract expense JSON only. TRANSCRIPT: {asr_text}"
        max_tokens = 150
    elif intent == 'invoice_create':
        doc_type = 'invoice'
        validator = validate_invoice
        runner = create_invoice
        prompt = f"Generate invoice JSON. TRANSCRIPT: {asr_text}"
        max_tokens = 200
    else:
        return

    try:
        resp = requests.post(HF_URL, json={'prompt': prompt, 'max_new_tokens': max_tokens})
        resp.raise_for_status()
        llm_text = resp.json().get('text','')
    except requests.exceptions.RequestException as e:
        raise HTTPException(status_code=503, detail=f"HF server unavailable: {e}")
    try:
        payload = json.loads(llm_text)
    except Exception:
        try:
            rr = requests.post(HF_URL, json={'prompt': 'Reformat to valid JSON only: ' + llm_text, 'max_new_tokens': 120})
            rr.raise_for_status()
            payload = json.loads(rr.json().get('text','{}'))
        except requests.exceptions.RequestException as e:
            raise HTTPException(status_code=503, detail=f"HF server unavailable: {e}")

    valid, err = validator(payload)
    if not valid:
        return {'error': 'Validation failed', 'details': err}

    res = runner(payload)
    whatsapp.send_text(from_number, f"{res['summary']}")
    logging.info(f"{doc_type.capitalize()} recorded for {from_number}")
    return {'status': 'ok', 'summary': res['summary']}

@app.post('/webhook/audio')
async def webhook_audio(from_number: str, audio: UploadFile = File(...)):
    logging.info(f"Received audio from {from_number}")
    # Send audio to ASR service
    files = {'file': (audio.filename, await audio.read(), audio.content_type)}
    try:
        r = requests.post(ASR_URL, files=files)
        r.raise_for_status()
        asr = r.json()
        logging.info(f"ASR response: {asr}")
    except requests.exceptions.RequestException as e:
        logging.error(f"ASR service unavailable: {e}")
        raise HTTPException(status_code=503, detail=f"ASR service unavailable: {e}")

    text = asr.get('text','').lower()
    
    # Call intent classifier service
    try:
        r = requests.post(INTENT_URL, json={'text': text})
        r.raise_for_status()
        intent = r.json().get('intent')
        logging.info(f"Intent: {intent}")
    except requests.exceptions.RequestException as e:
        logging.error(f"Intent classifier service unavailable: {e}")
        raise HTTPException(status_code=503, detail=f"Intent classifier service unavailable: {e}")

    if intent in ['expense_record', 'invoice_create']:
        return await process_document(intent, asr.get('text'), from_number)
    elif intent == 'gst_query':
        prompt = f"Answer GST question concisely for SME owner: {asr.get('text')}"
        try:
            resp = requests.post(HF_URL, json={'prompt': prompt, 'max_new_tokens': 150})
            resp.raise_for_status()
            whatsapp.send_text(from_number, resp.json().get('text',''))
        except requests.exceptions.RequestException as e:
            logging.error(f"HF server unavailable: {e}")
            raise HTTPException(status_code=503, detail=f"HF server unavailable: {e}")
        return {'status': 'ok'}

    else:
        whatsapp.send_text(from_number, "Sorry, I didn't understand. Can you repeat in short?")
        logging.info(f"Fallback for {from_number}")
        return {'status': 'fallback'}

@app.get('/health')
async def health_check():
    services = {
        "asr_service": ASR_URL,
        "intent_classifier": INTENT_URL,
        "hf_server": HF_URL.replace('/generate', '')
    }
    service_status = {}
    for service_name, url in services.items():
        try:
            r = requests.get(url + "/docs", timeout=1)
            if r.status_code == 200:
                service_status[service_name] = "ok"
            else:
                service_status[service_name] = "error"
        except requests.exceptions.RequestException:
            service_status[service_name] = "unavailable"
    return service_status

from typing import Optional



...



@app.get('/expenses/summary/daily')

...



@app.get('/expenses')

async def get_expenses(start_date: Optional[str] = None, end_date: Optional[str] = None):

    from datetime import datetime, date

    import os

    import json



    expenses = []

    

    expense_dir = 'data/expenses'

    if not os.path.exists(expense_dir):

        return expenses



    for filename in os.listdir(expense_dir):

        if filename.endswith(".json"):

            file_path = os.path.join(expense_dir, filename)

            with open(file_path, 'r') as f:

                try:

                    expense_data = json.load(f)

                    expense_date_str = expense_data.get('date')

                    if expense_date_str:

                        expense_date = datetime.strptime(expense_date_str, '%Y-%m-%d').date()

                        if start_date and end_date:

                            if datetime.strptime(start_date, '%Y-%m-%d').date() <= expense_date <= datetime.strptime(end_date, '%Y-%m-%d').date():

                                expenses.append(expense_data)

                        elif start_date:

                            if expense_date >= datetime.strptime(start_date, '%Y-%m-%d').date():

                                expenses.append(expense_data)

                        elif end_date:

                            if expense_date <= datetime.strptime(end_date, '%Y-%m-%d').date():

                                expenses.append(expense_data)

                        else:

                            expenses.append(expense_data)

                except (json.JSONDecodeError, ValueError):

                    # Ignore corrupted or invalid files

                    pass



    ...



        return expenses



    



    @app.get('/invoices')



    async def get_invoices(start_date: Optional[str] = None, end_date: Optional[str] = None):



        from datetime import datetime, date



        import os



        import json



    



        invoices = []



        



        invoice_dir = 'data/invoices'



        if not os.path.exists(invoice_dir):



            return invoices



    



        for filename in os.listdir(invoice_dir):



            if filename.endswith(".json"):



                file_path = os.path.join(invoice_dir, filename)



                with open(file_path, 'r') as f:



                    try:



                        invoice_data = json.load(f)



                        invoice_date_str = invoice_data.get('invoice_date')



                        if invoice_date_str:



                            invoice_date = datetime.strptime(invoice_date_str, '%Y-%m-%d').date()



                            if start_date and end_date:



                                if datetime.strptime(start_date, '%Y-%m-%d').date() <= invoice_date <= datetime.strptime(end_date, '%Y-%m-%d').date():



                                    invoices.append(invoice_data)



                            elif start_date:



                                if invoice_date >= datetime.strptime(start_date, '%Y-%m-%d').date():



                                    invoices.append(invoice_data)



                            elif end_date:



                                if invoice_date <= datetime.strptime(end_date, '%Y-%m-%d').date():



                                    invoices.append(invoice_data)



                            else:



                                invoices.append(invoice_data)



                    except (json.JSONDecodeError, ValueError):



                        # Ignore corrupted or invalid files



                        pass



    



                return invoices



    



        



    



        @app.get('/expenses/summary/monthly')



    



        async def monthly_expense_summary(year: int, month: int):



    



            from datetime import datetime



    



            import os



    



            import json



    



        



    



            total_amount = 0



    



            expense_count = 0



    



            



    



            expense_dir = 'data/expenses'



    



            if not os.path.exists(expense_dir):



    



                return {"total_amount": 0, "expense_count": 0}



    



        



    



            for filename in os.listdir(expense_dir):



    



                if filename.endswith(".json"):



    



                    file_path = os.path.join(expense_dir, filename)



    



                    with open(file_path, 'r') as f:



    



                        try:



    



                            expense_data = json.load(f)



    



                            expense_date_str = expense_data.get('date')



    



                            if expense_date_str:



    



                                expense_date = datetime.strptime(expense_date_str, '%Y-%m-%d').date()



    



                                if expense_date.year == year and expense_date.month == month:



    



                                    total_amount += expense_data.get('amount', 0)



    



                                    expense_count += 1



    



                        except (json.JSONDecodeError, ValueError):



    



                            # Ignore corrupted or invalid files



    



                            pass



    



        



    



            ...



    



        



    



                return {"total_amount": total_amount, "expense_count": expense_count}



    



        



    



            



    



        



    



            @app.get('/invoices/summary/monthly')



    



        



    



            async def monthly_invoice_summary(year: int, month: int):



    



        



    



                from datetime import datetime



    



        



    



                import os



    



        



    



                import json



    



        



    



            



    



        



    



                total_amount = 0



    



        



    



                invoice_count = 0



    



        



    



                



    



        



    



                invoice_dir = 'data/invoices'



    



        



    



                if not os.path.exists(invoice_dir):



    



        



    



                    return {"total_amount": 0, "invoice_count": 0}



    



        



    



            



    



        



    



                for filename in os.listdir(invoice_dir):



    



        



    



                    if filename.endswith(".json"):



    



        



    



                        file_path = os.path.join(invoice_dir, filename)



    



        



    



                        with open(file_path, 'r') as f:



    



        



    



                            try:



    



        



    



                                invoice_data = json.load(f)



    



        



    



                                invoice_date_str = invoice_data.get('invoice_date')



    



        



    



                                if invoice_date_str:



    



        



    



                                    invoice_date = datetime.strptime(invoice_date_str, '%Y-%m-%d').date()



    



        



    



                                    if invoice_date.year == year and invoice_date.month == month:



    



        



    



                                        total_amount += invoice_data.get('total', 0)



    



        



    



                                        invoice_count += 1



    



        



    



                            except (json.JSONDecodeError, ValueError):



    



        



    



                                # Ignore corrupted or invalid files



    



        



    



                                pass



    



        



    



            



    



        



    



                                return {"total_amount": total_amount, "invoice_count": invoice_count}



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                @app.get('/expenses/summary/yearly')



    



        



    



            



    



        



    



                async def yearly_expense_summary(year: int):



    



        



    



            



    



        



    



                    from datetime import datetime



    



        



    



            



    



        



    



                    import os



    



        



    



            



    



        



    



                    import json



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    total_amount = 0



    



        



    



            



    



        



    



                    expense_count = 0



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                    expense_dir = 'data/expenses'



    



        



    



            



    



        



    



                    if not os.path.exists(expense_dir):



    



        



    



            



    



        



    



                        return {"total_amount": 0, "expense_count": 0}



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    for filename in os.listdir(expense_dir):



    



        



    



            



    



        



    



                        if filename.endswith(".json"):



    



        



    



            



    



        



    



                            file_path = os.path.join(expense_dir, filename)



    



        



    



            



    



        



    



                            with open(file_path, 'r') as f:



    



        



    



            



    



        



    



                                try:



    



        



    



            



    



        



    



                                    expense_data = json.load(f)



    



        



    



            



    



        



    



                                    expense_date_str = expense_data.get('date')



    



        



    



            



    



        



    



                                    if expense_date_str:



    



        



    



            



    



        



    



                                        expense_date = datetime.strptime(expense_date_str, '%Y-%m-%d').date()



    



        



    



            



    



        



    



                                        if expense_date.year == year:



    



        



    



            



    



        



    



                                            total_amount += expense_data.get('amount', 0)



    



        



    



            



    



        



    



                                            expense_count += 1



    



        



    



            



    



        



    



                                except (json.JSONDecodeError, ValueError):



    



        



    



            



    



        



    



                                    # Ignore corrupted or invalid files



    



        



    



            



    



        



    



                                    pass



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        return {"total_amount": total_amount, "expense_count": expense_count}



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    @app.get('/invoices/summary/yearly')



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    async def yearly_invoice_summary(year: int):



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        from datetime import datetime



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        import os



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        import json



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        total_amount = 0



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        invoice_count = 0



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        invoice_dir = 'data/invoices'



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        if not os.path.exists(invoice_dir):



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                            return {"total_amount": 0, "invoice_count": 0}



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        for filename in os.listdir(invoice_dir):



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                            if filename.endswith(".json"):



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                file_path = os.path.join(invoice_dir, filename)



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                with open(file_path, 'r') as f:



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                    try:



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                        invoice_data = json.load(f)



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                        invoice_date_str = invoice_data.get('invoice_date')



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                        if invoice_date_str:



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                            invoice_date = datetime.strptime(invoice_date_str, '%Y-%m-%d').date()



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                            if invoice_date.year == year:



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                                total_amount += invoice_data.get('total', 0)



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                                invoice_count += 1



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                    except (json.JSONDecodeError, ValueError):



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                        # Ignore corrupted or invalid files



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                                        pass



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        return {"total_amount": total_amount, "invoice_count": invoice_count}



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    if __name__ == '__main__':



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        import uvicorn



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                        uvicorn.run('main:app', host='0.0.0.0', port=8000, reload=True)



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    # Test comment



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    



    



        



    



            



    



        



    



                



    



        



    



            



    



        



    



                    
